# Expense Tracker

## Description

This repository contains the code for an expense tracking telegram bot. The bot is built using `telegraf` for the connection layer, and `FastAPI`, `SQLAlchemy` and `langchain` for the parsing and persistence layer.

## Project Structure

This repository contains 2 services:

- `connector-service`: Written in TypeScript. It handles the connection to telegram and redirects user messages to the `bot-service`.
- `bot-service` Written in Python. It processes user messages, parsing them and saving the structured data into a PostgreSQL database.

## Installation

### Locally

To install the bot, you need to have the following dependencies installed:

- `uv 0.6.2` or greater.
- `Node.js LTS 22.14.0` or greater.

After installing these, you have to `cd` into the `bot-service` directory and run the following commands:

```bash
uv sync
```

After that, you should `cd` into the `connector-service` directory and run the following commands:

```bash
npm install
```

Once the dependencies are installed, you can go ahead and run the services.

### Docker

This repository contains Dockerfiles to run Docker containers with the services. If you wish to run the project with containers, you do not need to install the dependencies locally.

### Pre-Commit Hook

This repository contains a pre-commit hook that can be installed using `pre-commit`. In order to do so, you must have `pre-commit` installed. Then you can run the following command.

```bash
pre-commit install
```

If you are using `uv`, you can directly run:

```bash
uv run pre-commit install
```

This hook will run linting and formatting for both repos before commiting.

## Environment Variables

Before going on any further, you need to create a `.env` file in the `bot-service` and `connector-service` directories. In order to do so, you can copy the `.env.example` file in the respective directories and rename it to `.env`. THen you can fill in the values for the environment variables.

### Bot Service

The following environment variables are required for the bot service:

```env
AI21_API_KEY=<YOUR_API_KEY> # The API key for the AI21 API.
POSTGRES_USER=<YOUR_POSTGRES_USER>
POSTGRES_PASSWORD=<YOUR_POSTGRES_PASSWORD>
POSTGRES_DB=<YOUR_POSTGRES_DB>
POSTGRES_HOST=<YOUR_POSTGRES_HOST>
LOG_LEVEL=INFO
```

### Connector Service

The following environment variables are required for the connector service:

```env
BOT_TOKEN=<YOUR_BOT_TOKEN> # The token for the telegram bot, obtained from the BotFather.
BOT_SERVICE_URL=<YOUR_BOT_SERVICE_URL> # The URL for the bot service.
BOT_SERVICE_API_KEY=<YOUR_BOT_SERVICE_API_KEY> # The API key for the bot service.
WEBHOOK_DOMAIN=<YOUR_WEBHOOK_DOMAIN> # The domain for the webhook.
PORT=<YOUR_WEBHOOK_PORT> # The port for the webhook. Defaults to 3000.
```

The `BOT_SERVICE_API_KEY` is a secret key that is used to authenticate requests from the connector service to the bot service. It is generated by the bot service the first time it is run, and should be copied to the `.env` file in the connector service.

### Environment Variables on Docker

When running the project with Docker, you should be careful when setting environment variables, especially those that are related to URLs, since we will be using the internal docker network:
bot-service

**`connector-service`**

```env
BOT_SERVICE_URL=http;//bot-service
```

**`bot-service`**

```env
POSTGRES_HOST=db
```

## Running the services

### Running the Database

In order to run the database, you should execute the following command:

```bash
docker compose up db -d
```

This will start a docker container running the PostgreSQL database.

### Running Locally

To run the bot service, you have to `cd` into the `bot-service` directory and run the following command:

```bash
uv run fastapi run
```

Once the bot service is running, you can start the connector service by `cd`ing into the `connector-service` directory and running the following commands:

```bash
npm run build && npm run start
```

After running these commands, the bot should be up and able to reply to messages.

### Running on Docker

If you want to run all of the services on docker you can run this command:

```bash
docker compose up
```

Or alternatively:

```bash
docker compose up bot-service
docker compose up connector-service
```

## Usage

In order to use the bot, you can directly message it on telegram. However, keep in mind that if you are not whitelisted, the bot will not respond to your messages. You can whitelist your `telegram_id` by adding your value to the `users` table on the database.

Messages sent to the bot are expected to be expense related. For example: "Pizza 10 bucks". This should be parsed using a LLM and stored in the `expenses` table.

In the hypothetical case that you send an incomplete message, the bot will ask you for the missing information. However, if you send a non-expense related message, the bot will not respond.
